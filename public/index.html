<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Debate entre dos IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center">
  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-3xl">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">
      Debate entre dos IA (progresivo)
    </h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="topic">Tema del debate</label>
        <input id="topic" type="text" placeholder="Futuro de la educaci√≥n con IA"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="interactions">Interacciones</label>
        <input id="interactions" type="number" min="1" max="12" value="5"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
      </div>
    </div>

    <div class="flex gap-3 mb-4">
      <button id="run"
              class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
        Iniciar conversaci√≥n
      </button>
      <button id="stop"
              class="flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
        Detener
      </button>
      <button id="clear"
              class="flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition">
        Limpiar
      </button>
    </div>

    <div id="status" class="text-sm text-gray-500 mb-2"></div>

    <div id="log"
         class="h-80 overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg p-4 whitespace-pre-wrap font-mono text-sm">
      Aqu√≠ aparecer√° la conversaci√≥n‚Ä¶
    </div>
  </div>

  <script>
    const $run = document.getElementById('run');
    const $stop = document.getElementById('stop');
    const $clear = document.getElementById('clear');
    const $log = document.getElementById('log');
    const $status = document.getElementById('status');

    let playing = false;

    function sleep(ms) {
      return new Promise(res => setTimeout(res, ms));
    }

    function appendLine(text) {
      const line = document.createElement('div');
      line.textContent = text;
      $log.appendChild(line);
      $log.scrollTop = $log.scrollHeight; // auto-scroll
    }

    function setBusy(busy) {
      $run.disabled = busy;
      $stop.disabled = !busy;
    }

    $clear.onclick = () => {
      $log.textContent = '';
      $status.textContent = '';
    };

    $stop.onclick = () => {
      playing = false;
      $status.textContent = 'Detenido por el usuario.';
      setBusy(false);
    };

    $run.onclick = async () => {
      const topic = document.getElementById('topic').value.trim() || 'Tema libre';
      const interactions = Number(document.getElementById('interactions').value) || 5;
      const delay = 1200; // üîí fijo a 1.2 segundos

      setBusy(true);
      playing = true;
      $log.textContent = '';
      $status.textContent = 'Generando conversaci√≥n‚Ä¶';

      try {
        const params = new URLSearchParams({
          interactions: String(interactions),
          max_tokens: '80',
          topic
        });

        const res = await fetch(`/.netlify/functions/dialog?${params}`);
        if (!res.ok) throw new Error(await res.text());

        const data = await res.json();
        const convo = Array.isArray(data.conversation) ? data.conversation : [];

        for (const turn of convo) {
          if (!playing) break;
          appendLine(`${turn.speaker}: ${turn.message}`);
          await sleep(delay);
        }

        if (playing) $status.textContent = 'Conversaci√≥n finalizada.';
      } catch (e) {
        appendLine(`‚ö†Ô∏è Error: ${e.message || e}`);
        $status.textContent = 'Ocurri√≥ un error.';
      } finally {
        playing = false;
        setBusy(false);
      }
    };

    setBusy(false);
  </script>
</body>
</html>
