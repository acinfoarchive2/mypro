<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Publicador de Artículos para Blogger</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-100 min-h-screen py-10 px-4">
  <main class="mx-auto w-full max-w-3xl bg-white shadow-2xl rounded-2xl p-8">
    <header class="mb-8 text-center">
      <h1 class="text-3xl font-bold text-indigo-600">Enviar artículo a Blogger</h1>
      <p class="text-sm text-slate-500 mt-2">
        Redacta tu artículo, añade una imagen y publícalo en tu blog con un solo clic.
      </p>
    </header>

    <form id="postForm" class="space-y-6">
      <div>
        <label for="title" class="block text-sm font-semibold text-slate-700 mb-1">Título del artículo</label>
        <input id="title" name="title" type="text" required
               class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300"
               placeholder="Escribe un título atractivo" />
      </div>

      <div>
        <label for="content" class="block text-sm font-semibold text-slate-700 mb-1">Contenido</label>
        <textarea id="content" name="content" rows="10" required
                  class="w-full rounded-lg border border-slate-300 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-300"
                  placeholder="Escribe tu artículo aquí..."></textarea>
        <p class="text-xs text-slate-400 mt-1">Las líneas en blanco se transforman en párrafos al publicar.</p>
      </div>

      <div>
        <label for="image" class="block text-sm font-semibold text-slate-700 mb-1">Imagen principal</label>
        <input id="image" name="image" type="file" accept="image/*"
               class="w-full text-sm text-slate-600" />
        <p class="text-xs text-slate-400 mt-1">Opcional. La imagen se insertará al inicio del artículo.</p>

        <div id="previewWrapper" class="mt-4 hidden">
          <p class="text-xs uppercase text-slate-400 mb-2">Vista previa</p>
          <img id="imagePreview" alt="Vista previa de la imagen seleccionada"
               class="max-h-64 w-full object-contain rounded-lg border border-dashed border-indigo-200" />
        </div>
      </div>

      <div class="flex flex-col sm:flex-row gap-3">
        <button type="submit"
                class="flex-1 rounded-lg bg-indigo-600 text-white font-semibold py-2 px-4 transition hover:bg-indigo-700 disabled:bg-indigo-300 disabled:cursor-not-allowed">
          Publicar en Blogger
        </button>
        <button type="button" id="resetBtn"
                class="flex-1 rounded-lg border border-slate-300 text-slate-600 font-semibold py-2 px-4 transition hover:bg-slate-50">
          Limpiar formulario
        </button>
      </div>
    </form>

    <section class="mt-8">
      <div id="status" class="text-sm text-slate-500"></div>
      <div id="result" class="mt-4 text-sm"></div>
    </section>

    <section class="mt-10 bg-indigo-50 border border-indigo-200 rounded-xl p-4 text-sm text-slate-600">
      <h2 class="text-base font-semibold text-indigo-600">Configuración necesaria</h2>
      <ul class="list-disc list-inside mt-2 space-y-1">
        <li>Define en Netlify (o en tu entorno local) la variable <code>BLOGGER_ACCESS_TOKEN</code> con un token OAuth válido para la API de Blogger.</li>
        <li>Opcionalmente define <code>BLOGGER_BLOG_ID</code>; por defecto se usará el blog <strong>7027208528883466919</strong>.</li>
        <li>El artículo se publica mediante la función <code>/.netlify/functions/publish</code>.</li>
      </ul>
    </section>
  </main>

  <script>
    const form = document.getElementById('postForm');
    const resetBtn = document.getElementById('resetBtn');
    const imageInput = document.getElementById('image');
    const imagePreview = document.getElementById('imagePreview');
    const previewWrapper = document.getElementById('previewWrapper');
    const statusEl = document.getElementById('status');
    const resultEl = document.getElementById('result');

    let imageDataUrl = '';

    function setStatus(message, type = 'info') {
      const colors = {
        info: 'text-slate-500',
        success: 'text-emerald-600',
        error: 'text-rose-600'
      };
      statusEl.className = `text-sm font-medium ${colors[type] || colors.info}`;
      statusEl.textContent = message;
    }

    function setResult(message, url) {
      if (!message) {
        resultEl.innerHTML = '';
        return;
      }

      const linkHtml = url ? `<a href="${url}" target="_blank" rel="noopener" class="text-indigo-600 underline">Ver publicación</a>` : '';
      resultEl.innerHTML = `<div class="p-4 rounded-lg border border-slate-200 bg-slate-50">${message}${linkHtml ? `<div class="mt-2">${linkHtml}</div>` : ''}</div>`;
    }

    function resetForm() {
      form.reset();
      imageDataUrl = '';
      previewWrapper.classList.add('hidden');
      imagePreview.src = '';
      setStatus('');
      setResult('');
    }

    async function readFileAsDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = () => reject(new Error('No se pudo leer el archivo.'));
        reader.readAsDataURL(file);
      });
    }

    imageInput.addEventListener('change', async (event) => {
      const [file] = event.target.files;
      if (!file) {
        imageDataUrl = '';
        previewWrapper.classList.add('hidden');
        imagePreview.src = '';
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        setStatus('La imagen debe pesar menos de 5 MB.', 'error');
        imageInput.value = '';
        return;
      }

      try {
        imageDataUrl = await readFileAsDataUrl(file);
        previewWrapper.classList.remove('hidden');
        imagePreview.src = imageDataUrl;
        setStatus('Imagen cargada correctamente.', 'success');
      } catch (error) {
        setStatus(error.message, 'error');
        imageInput.value = '';
      }
    });

    resetBtn.addEventListener('click', (event) => {
      event.preventDefault();
      resetForm();
    });

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      setResult('');

      const title = form.title.value.trim();
      const content = form.content.value.trim();

      if (!title || !content) {
        setStatus('El título y el contenido son obligatorios.', 'error');
        return;
      }

      setStatus('Enviando artículo a Blogger…', 'info');
      const submitButton = form.querySelector('button[type="submit"]');
      submitButton.disabled = true;

      try {
        const response = await fetch('/.netlify/functions/publish', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ title, content, imageDataUrl })
        });

        const payload = await response.json().catch(() => ({}));

        if (!response.ok) {
          const message = payload && payload.error ? payload.error : 'No se pudo publicar el artículo.';
          throw new Error(message);
        }

        const { url } = payload;
        setStatus('Artículo publicado correctamente.', 'success');
        setResult('Tu artículo ya está disponible en Blogger.', url);
        resetForm();
      } catch (error) {
        setStatus(error.message || 'Ocurrió un error inesperado.', 'error');
      } finally {
        submitButton.disabled = false;
      }
    });
  </script>
</body>
</html>
