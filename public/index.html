<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Debate entre dos IA</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen px-4 py-6">
  <div class="bg-white shadow-xl rounded-2xl p-6 w-full max-w-3xl mx-auto">
    <h1 class="text-2xl font-bold text-center text-blue-600 mb-6">
      Debate entre dos IA (progresivo)
    </h1>

    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="topic">Tema del debate</label>
        <input id="topic" type="text" placeholder="Futuro de la educación con IA"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
      </div>

      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1" for="interactions">Interacciones</label>
        <input id="interactions" type="number" min="1" max="12" value="5"
               class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring focus:ring-blue-200">
      </div>
    </div>

    <div class="flex flex-col sm:flex-row gap-3 mb-4">
      <button id="run"
              class="w-full sm:flex-1 bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition">
        Iniciar conversación
      </button>
      <button id="stop"
              class="w-full sm:flex-1 bg-gray-200 hover:bg-gray-300 text-gray-800 font-semibold py-2 px-4 rounded-lg transition">
        Detener
      </button>
      <button id="clear"
              class="w-full sm:flex-1 bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-2 px-4 rounded-lg transition">
        Limpiar
      </button>
    </div>

    <div id="status" class="text-sm text-gray-500 mb-2"></div>

    <div id="log"
         class="max-h-[60vh] overflow-y-auto bg-gray-50 border border-gray-200 rounded-lg p-4 space-y-3">
      <div class="text-gray-400 text-sm text-center">Aquí aparecerá la conversación…</div>
    </div>
  </div>

  <script>
    const $run = document.getElementById('run');
    const $stop = document.getElementById('stop');
    const $clear = document.getElementById('clear');
    const $log = document.getElementById('log');
    const $status = document.getElementById('status');

    let playing = false;

    function sleep(ms) {
      return new Promise(res => setTimeout(res, ms));
    }

    function stylesFor(speaker) {
      const isAlpha = speaker.toLowerCase() === 'alpha';
      return {
        row: isAlpha ? 'justify-start' : 'justify-end',
        bubble: isAlpha
          ? 'bg-blue-50 border border-blue-200'
          : 'bg-emerald-50 border border-emerald-200',
        avatarBg: isAlpha ? 'bg-blue-600' : 'bg-emerald-600',
        initial: isAlpha ? 'A' : 'B',
        side: isAlpha ? 'flex-row' : 'flex-row-reverse',
        alignText: isAlpha ? 'text-left' : 'text-right'
      };
    }

    function appendMessage(speaker, message) {
      const s = stylesFor(speaker);

      const row = document.createElement('div');
      row.className = `w-full flex ${s.row}`;

      const wrap = document.createElement('div');
      wrap.className = `max-w-[85%] flex ${s.side} items-start gap-3`;

      const avatar = document.createElement('div');
      avatar.className = `h-8 w-8 rounded-full ${s.avatarBg} text-white flex items-center justify-center font-bold shrink-0`;
      avatar.textContent = s.initial;

      const bubble = document.createElement('div');
      bubble.className = `px-3 py-2 rounded-2xl ${s.bubble} shadow-sm`;
      const name = document.createElement('div');
      name.className = `text-xs font-semibold text-gray-600 ${s.alignText} mb-0.5`;
      name.textContent = speaker;
      const text = document.createElement('div');
      text.className = `text-sm text-gray-900 leading-relaxed ${s.alignText}`;
      text.textContent = message;

      bubble.appendChild(name);
      bubble.appendChild(text);

      wrap.appendChild(avatar);
      wrap.appendChild(bubble);

      row.appendChild(wrap);
      $log.appendChild(row);

      $log.scrollTop = $log.scrollHeight;
    }

    function setBusy(busy) {
      $run.disabled = busy;
      $stop.disabled = !busy;
    }

    $clear.onclick = () => {
      $log.innerHTML = '<div class="text-gray-400 text-sm text-center">Aquí aparecerá la conversación…</div>';
      $status.textContent = '';
    };

    $stop.onclick = () => {
      playing = false;
      $status.textContent = 'Detenido por el usuario.';
      setBusy(false);
    };

    $run.onclick = async () => {
      const topic = document.getElementById('topic').value.trim() || 'Tema libre';
      const interactions = Number(document.getElementById('interactions').value) || 5;
      const delay = 5200;

      setBusy(true);
      playing = true;
      $log.innerHTML = '';
      $status.textContent = 'Generando conversación…';

      try {
        const params = new URLSearchParams({
          interactions: String(interactions),
          max_tokens: '30',
          topic
        });

        const res = await fetch(`/.netlify/functions/dialog?${params}`);
        if (!res.ok) throw new Error(await res.text());

        const data = await res.json();
        const convo = Array.isArray(data.conversation) ? data.conversation : [];

        for (const turn of convo) {
          if (!playing) break;
          appendMessage(turn.speaker, turn.message);
          await sleep(delay);
        }

        if (playing) $status.textContent = 'Conversación finalizada.';
      } catch (e) {
        appendMessage('Sistema', `⚠️ Error: ${e.message || e}`);
        $status.textContent = 'Ocurrió un error.';
      } finally {
        playing = false;
        setBusy(false);
      }
    };

    setBusy(false);
  </script>
</body>
</html>
